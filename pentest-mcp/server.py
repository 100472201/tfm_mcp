import json
import os
import subprocess
import sys
from pathlib import Path
from urllib.parse import urlparse

from mcp.server.fastmcp import FastMCP

mcp = FastMCP("pentest-mcp")

REPORTS_DIR = Path(os.environ.get("PENTEST_REPORTS_DIR", "./reports")).resolve()
REPORTS_DIR.mkdir(parents=True, exist_ok=True)

DEFAULT_ALLOWED = {"localhost", "127.0.0.1", "juiceshop", "dvwa"}
EXTRA = set(filter(None, os.environ.get("PENTEST_ALLOWED_HOSTS", "").split(",")))
ALLOWED_HOSTS = DEFAULT_ALLOWED | EXTRA

def _ensure_allowed_target(target_url: str) -> None:
    u = urlparse(target_url)
    if u.scheme not in ("http", "https"):
        raise ValueError("Solo se permite http/https.")
    host = (u.hostname or "").strip().lower()
    if host not in ALLOWED_HOSTS:
        raise ValueError(
            f"Host no permitido: {host}. Permitidos: {sorted(ALLOWED_HOSTS)}. "
            "Añade más con PENTEST_ALLOWED_HOSTS (solo para tu lab)."
        )

@mcp.tool()
def zap_baseline_scan(
    target_url: str,
    docker_network: str = "zapnet",
    minutes: int | str = 1,
    report_prefix: str = "zap"
) -> dict:
    """
    Ejecuta OWASP ZAP baseline scan (spider + pasivo) contra un objetivo permitido.
    Devuelve rutas a reportes y un resumen básico.
    """
    _ensure_allowed_target(target_url)

    # Convertimos minutes (por si el Inspector lo manda como string)
    try:
        minutes_int = int(minutes)
    except Exception:
        raise ValueError(f"'minutes' debe ser un entero. Recibido: {minutes!r}")

    # Rutas de salida (DEBEN definirse antes de usar json_out/html_out)
    json_out = REPORTS_DIR / f"{report_prefix}.json"
    html_out = REPORTS_DIR / f"{report_prefix}.html"

    cmd = [
        "docker", "run", "--rm",
        "--network", docker_network,
        "-v", f"{REPORTS_DIR}:/zap/wrk:rw",
        "-t", "ghcr.io/zaproxy/zaproxy:stable",
        "zap-baseline.py",
        "-t", target_url,
        "-m", str(minutes_int),
        "-J", json_out.name,
        "-r", html_out.name,
    ]

    p = subprocess.run(cmd, capture_output=True, text=True)

    return {
        "ok": p.returncode == 0,
        "returncode": p.returncode,
        "target": target_url,
        "reports": {"json": str(json_out), "html": str(html_out)},
        "stdout_tail": (p.stdout or "")[-2000:],
        "stderr_tail": (p.stderr or "")[-2000:],
        "note": "Baseline scan: spider + passive scan (sin ataques activos).",
    }

@mcp.tool()
def read_zap_report(report_json_path: str) -> dict:
    """
    Lee el JSON generado por ZAP baseline y devuelve un resumen.
    """
    path = Path(report_json_path).expanduser().resolve()
    if not path.exists():
        raise FileNotFoundError(f"No existe: {path}")

    data = json.loads(path.read_text(encoding="utf-8", errors="replace"))
    site = data.get("site") or []
    alerts = []

    for s in site:
        for a in (s.get("alerts") or []):
            alerts.append({
                "risk": a.get("riskdesc") or a.get("risk"),
                "name": a.get("name"),
                "desc": a.get("desc"),
                "solution": a.get("solution"),
                "reference": a.get("reference"),
                "instances": len(a.get("instances") or []),
            })

    return {
        "alerts_count": len(alerts),
        "alerts": alerts[:50],
        "truncated": len(alerts) > 50
    }

@mcp.tool()
def ping() -> str:
    return "pong"

if __name__ == "__main__":
    # IMPORTANTE: no imprimir a stdout en servidores stdio MCP
    print("pentest-mcp arrancado (stdio)", file=sys.stderr)
    mcp.run(transport="stdio")